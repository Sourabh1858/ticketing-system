{% extends "base.html" %}

{% block title %}All Users{% endblock %}

{% block content %}
<!-- Loader Section -->
<div id="loader" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 1050;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container mt-4">
    <h1>All Users</h1>

    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th scope="col">Username</th>
                <th scope="col">Project</th>
                <th scope="col">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <form method="POST" class="mb-3" onsubmit="showLoader(event)">
                {% csrf_token %}
                <tr>
                    <!-- Username field -->
                    <td>
                        <input type="text" name="username" class="form-control" value="{{ user.user.username }}" required>
                    </td>

                    <!-- Project multi-select field -->
                    <td>
                        <select id="project-{{ user.user.id }}" name="project" class="form-control" multiple required style="width: 100%">
                            {% for value, label in project_options %}
                                <option value="{{ value }}" 
                                    {% if value in user.project %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- Hidden field for user ID -->
                    <input type="hidden" name="user_id" value="{{ user.user.id }}">

                    <!-- Save button -->
                    <td>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </td>
                </tr>
            </form>
            {% endfor %}
        </tbody>
    </table>

    <a href="{% url 'tickets:index' %}" class="btn btn-secondary mt-3">Back to Tickets</a>
</div>

<!-- Include Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function() {
    // Initialize Select2 on each project select element
    $('select[id^="project-"]').select2({
      placeholder: 'Select project(s)',
      allowClear: true
    });
  });

  // Functions to show and hide the loader
  function showLoader(event) {
      event.preventDefault(); // Prevent the form from submitting immediately
      $('#loader').removeClass('d-none'); // Show the loader

      // Simulate form submission with a timeout (remove this if actual AJAX is used)
      setTimeout(function() {
          event.target.submit(); // Submit the form after showing the loader
      }, 3000); // Adjust this timeout duration as needed
  }

  function hideLoader() {
      $('#loader').addClass('d-none'); // Hide the loader
  }
</script>

{% endblock %}

{% comment %} {% extends 'base.html' %}

{% block title %}Edit User{% endblock %}

{% block content %}
<div class="container mt-5" style="width:100%">
    <h2>Edit User</h2>

    <!-- Form to edit user -->
    <form id="editUserForm" method="POST">
        {% csrf_token %}
        <div class="form-group">
            <label for="username">Username:</label>
            <select id="username" name="username" class="form-control">
                <option value="">Select a user</option>
                {% for user in users %}
                    <option value="{{ user.username }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="password">Password (Leave blank to keep current password):</label>
            <input type="password" id="password" name="password" class="form-control">
        </div>

        <div class="form-group">
            <label for="project">Project:</label>
            <select id="project" name="project" class="form-control" multiple="multiple">
                {% for value, label in projects %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div><br>
        <button type="submit" class="btn btn-primary">Update User</button>
    </form>

    <!-- Success message box -->
    <div id="successMessage" class="alert alert-success mt-3" style="display:none;"></div>

    <a href="{% url 'tickets:index' %}" class="btn btn-secondary mt-3">Back to Tickets</a>
</div>

<!-- Include Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function() {
    // Initialize Select2 on the project select element
    $('#project').select2({
      placeholder: 'Select project(s)',
      allowClear: true
    });

    // Check if there is a success message in localStorage and show it
    if (localStorage.getItem('successMessage')) {
      $('#successMessage').text(localStorage.getItem('successMessage')).show();
      localStorage.removeItem('successMessage');  // Remove message after showing
    }

    // Handle form submission via AJAX
    $('#editUserForm').on('submit', function(e) {
      e.preventDefault();  // Prevent form from submitting the traditional way

      var formData = $(this).serialize();  // Serialize form data

      $.ajax({
        type: 'POST',
        url: '',  // Use the same URL
        data: formData,
        success: function(response) {
          if (response.success) {
            // Store success message in localStorage
            localStorage.setItem('successMessage', response.message);
            // Refresh the page after a slight delay to show the message
            setTimeout(function() {
              window.location.reload();
            }, 200);  // Small delay to ensure the message is stored before reload
          }
        },
        error: function(xhr, status, error) {
          console.log('Error: ' + error);  // Handle any error responses
        }
      });
    });

    // Populate user data when username is selected
    $('#username').change(function() {
      var username = $(this).val();
      if (username) {
        $.getJSON('/get-user-data/' + username + '/', function(data) {
          $('#email').val(data.email);
          $('#project').val(data.projects).trigger('change');  // Populate and trigger Select2 update
        });
      } else {
        $('#email').val('');
        $('#project').val(null).trigger('change');  // Clear fields
      }
    });
  });
</script>
{% endblock %} {% endcomment %}





