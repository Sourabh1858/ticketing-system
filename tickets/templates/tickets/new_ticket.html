{% extends "base.html" %}

{% block content %}
<!-- Loader Section -->
<div id="loader" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 1050;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container mt-4">
    <!-- Toast notifications for messages -->
    <div aria-live="polite" aria-atomic="true" class="bg-body-secondary position-relative bd-example-toasts rounded-3">
        <div class="toast-container p-3" id="toastPlacement" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050;">
            {% if messages %}
                {% for message in messages %}
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <strong class="me-auto">Notification</strong>
                            <small class="text-muted">{{ message.timestamp }}</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            {{ message|safe }}  <!-- Allow safe HTML for links in the message -->
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
<div style="margin-top: 60px">
    {% if not user.is_authenticated %}
        <div class="d-flex justify-content-between align-items-center">
            <!-- Include header on the left side -->
            {% include "tickets/header.html" %}
            
            <!-- Button aligned to the right -->
            <div>
                <a href="{% url 'accounts:dashboard' %}" class="btn btn-primary">Back to Dashboard</a>
            </div>
        </div>
    {% endif %}
</div><br>
    <h1 class="mb-4">New Ticket</h1>

    <form method="post" onsubmit="showLoader()">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- Project selection dropdown -->
        <div class="mb-3">
            <label for="{{ form.project.id_for_label }}" class="form-label">{{ form.project.label }}</label>
            {{ form.project }}
        </div>

        <!-- Assignee dropdown -->
        <div class="mb-3">
            <label for="{{ form.assignee.id_for_label }}" class="form-label">{{ form.assignee.label }}</label>
            {{ form.assignee }}
        </div>

        <!-- Other fields -->
        {% for field in form %}
            {% if not field.name == "project" and not field.name == "assignee" %}
            <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}

        <button class="btn btn-primary" type="submit">Submit</button>
    </form>

</div><br>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Event listener to change assignee options based on project selection
        $('#id_project').change(function() {
            var project = $(this).val();
            
            // Show loader while fetching data
            showLoader();

            $.ajax({
                url: '{% url "tickets:filter_assignees_by_project" %}',  // URL to the view
                data: {
                    'project': project
                },
                success: function(response) {
                    // Hide the loader after response
                    hideLoader();
                    
                    // Update the assignee select dropdown with the new options
                    $('#id_assignee').html(response.assignee_options);

                    // If the response indicates to show a toast, trigger it
                    if (response.show_toast) {
                        var toastHTML = `
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header">
                                    <strong class="me-auto">Notification</strong>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">
                                    ${response.toast_message}
                                </div>
                            </div>`;
                        
                        // Append the toast message to the toast container
                        $('#toastPlacement').html(toastHTML);
                    }
                },
                error: function() {
                    hideLoader(); // Hide loader if an error occurs
                    alert('An error occurred while fetching the assignees.');
                }
            });
        });
    });

    // Functions to show and hide the loader
    function showLoader() {
        const loader = document.getElementById('loader');
        loader.classList.remove('d-none');
    }

    function hideLoader() {
        const loader = document.getElementById('loader');
        loader.classList.add('d-none');
    }
</script>

{% endblock %}